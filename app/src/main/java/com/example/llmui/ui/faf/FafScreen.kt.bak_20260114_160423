package com.example.llmui.ui.faf

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.Button
import androidx.compose.material3.Slider
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.example.llmui.audio.OboeDsp

@Composable
fun FafScreen() {
    // Upewniamy się, że silnik audio działa (idempotentne)
    LaunchedEffect(Unit) {
        OboeDsp.start()
    }

    var mix by remember { mutableStateOf(OboeDsp.getFafMix()) }
    var pitch by remember { mutableStateOf(OboeDsp.getFafPitchRatio()) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .verticalScroll(rememberScrollState())
            .padding(16.dp)
    ) {
        Text("FAF – Frequency Altered Feedback")
        Spacer(Modifier.height(8.dp))
        Text("Eksperymentalny filtr zmieniający wysokość głosu w słuchawkach.")

        Spacer(Modifier.height(24.dp))
        Text("Miks FAF (ile zmienionego głosu):")
        Slider(
            value = mix,
            onValueChange = {
                mix = it
                OboeDsp.setFafMix(it)
            },
            valueRange = 0f..1f
        )
        Text("Miks: ${(mix * 100).toInt()} %")

        Spacer(Modifier.height(24.dp))
        Text("Pitch (wysokość głosu):")
        Slider(
            value = pitch,
            onValueChange = {
                pitch = it
                OboeDsp.setFafPitchRatio(it)
            },
            valueRange = 0.8f..1.2f
        )
        Text("Współczynnik: ${String.format(\"%.2f\", pitch)}")

        Spacer(Modifier.height(24.dp))
        Text("Presety:")

        Spacer(Modifier.height(8.dp))
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Button(
                modifier = Modifier.weight(1f),
                onClick = {
                    pitch = 0.94f  // lekko niżej
                    mix = 0.7f
                    OboeDsp.setFafPitchRatio(pitch)
                    OboeDsp.setFafMix(mix)
                }
            ) {
                Text("Nisko")
            }

            Button(
                modifier = Modifier.weight(1f),
                onClick = {
                    pitch = 1.06f  // lekko wyżej
                    mix = 0.7f
                    OboeDsp.setFafPitchRatio(pitch)
                    OboeDsp.setFafMix(mix)
                }
            ) {
                Text("Wysoko")
            }

            Button(
                modifier = Modifier.weight(1f),
                onClick = {
                    pitch = 1.0f
                    mix = 0.0f
                    OboeDsp.setFafPitchRatio(pitch)
                    OboeDsp.setFafMix(mix)
                }
            ) {
                Text("Off")
            }
        }

        Spacer(Modifier.height(24.dp))
        Text("Uwaga: FAF jest przeznaczony do pracy NA SŁUCHAWKACH. "
                + "Bez słuchawek może powodować sprzężenia.")
    }
}
