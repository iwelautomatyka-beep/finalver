package com.example.llmui.ui.daf

import android.content.Context
import android.media.AudioDeviceInfo
import android.media.AudioManager
import android.os.Build
import android.widget.Toast
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Divider
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Slider
import androidx.compose.material3.SliderDefaults
import androidx.compose.material3.Switch
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.example.llmui.audio.OboeDsp
import kotlin.math.roundToInt

enum class DafPreset { GENTLE, STANDARD, STRONG, CUSTOM }
@Composable
fun DafScreen() {
    var currentPreset by rememberSaveable { mutableStateOf(DafPreset.GENTLE) }

    val context = LocalContext.current

    // Master ON/OFF dla całego silnika DAF (z blokadą na słuchawki)
    var dafEnabled by rememberSaveable { mutableStateOf(false) }

    // Główne parametry DAF
    var delayMs by rememberSaveable { mutableStateOf(120f) }   // 0..300 ms
    var gain by rememberSaveable { mutableStateOf(1.1f) }      // 0.4 – 2.0

    // LED bar – na razie oparty o Gain + stan DAF
    val ledLevel =
        if (dafEnabled) (gain / 2f).coerceIn(0f, 1f)
        else 0f

    val ledStatusText = when {
        !dafEnabled -> "DAF wyłączony"
        ledLevel < 0.25f -> "Delikatny odsłuch"
        ledLevel < 0.6f -> "Komfortowy poziom"
        else -> "Uwaga: może być głośno"
    }

    // Start/stop silnika audio zależnie od dafEnabled
    LaunchedEffect(dafEnabled) {
        try {
            if (dafEnabled) {
                OboeDsp.start()
            } else {
                OboeDsp.stop()
            }
        } catch (_: Throwable) {
        }
    }

    // Aktualizacja parametrów DAF, tylko gdy DAF jest aktywny
    LaunchedEffect(dafEnabled, delayMs, gain) {
        try {
            if (!dafEnabled) {
                // Bezpiecznie wyłącz efekt
                OboeDsp.setFeedbackMode(false)
                OboeDsp.setDelayMs(0)
                return@LaunchedEffect
            }

            OboeDsp.setDelayMs(delayMs.roundToInt())
            OboeDsp.setGain(gain)
            OboeDsp.setFeedbackMode(true)
        } catch (_: Throwable) {
        }
    }

    val wiredPresent = hasWiredHeadphones(context)
    val scrollState = rememberScrollState()

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
            .verticalScroll(scrollState),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        // Ostrzeżenie o słuchawkach, jeśli nie są podłączone
        if (!wiredPresent) {
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.errorContainer
                )
            ) {
                Text(
                    text = "Tryb DAF wymaga przewodowych słuchawek (jack/USB). " +
                            "Podłącz słuchawki, aby włączyć odsłuch z opóźnieniem.",
                    modifier = Modifier.padding(12.dp),
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onErrorContainer
                )
            }
        }

        // NAGŁÓWEK + MIC LED
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surfaceVariant
            )
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(
                    modifier = Modifier.weight(1f),
                    verticalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    Text(
                        text = "Tryb DAF – Delayed Auditory Feedback",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "Dziecko mówi do mikrofonu w słuchawkach przewodowych, " +
                                "a swój głos słyszy z kontrolowanym opóźnieniem. " +
                                "Ustaw opóźnienie i głośność.",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Column(
                    modifier = Modifier
                        .padding(start = 12.dp)
                        .width(72.dp),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.Center
                ) {
                    Text(
                        text = "MIC",
                        style = MaterialTheme.typography.labelSmall
                    )
                    Spacer(modifier = Modifier.height(4.dp))
                    MicLevelBar(
                        level = ledLevel,
                        modifier = Modifier
                            .height(52.dp)
                            .width(14.dp)
                    )
                    Spacer(modifier = Modifier.height(4.dp))
                    Text(
                        text = ledStatusText,
                        style = MaterialTheme.typography.labelSmall,
                        textAlign = TextAlign.Center
                    )
                }
            }
        }

        // BLOK STERUJĄCY DAF (master switch + delay + gain)
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {

                // MASTER: Audio DAF – wł/wył
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Column(
                        modifier = Modifier.weight(1f),
                        verticalArrangement = Arrangement.spacedBy(2.dp)
                    ) {
                        Text(
                            text = "Audio DAF – włącz / wyłącz",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.SemiBold
                        )
                        Text(
                            text = "Po włączeniu dziecko słyszy własny głos z opóźnieniem. " +
                                    "Używaj wyłącznie ze słuchawkami przewodowymi.",
                            style = MaterialTheme.typography.bodySmall
                        )
                    }
                    Switch(
                        checked = dafEnabled,
                        onCheckedChange = { wantEnable ->
                            if (wantEnable) {
                                if (hasWiredHeadphones(context)) {
                                    dafEnabled = true
                                } else {
                                    dafEnabled = false
                                    Toast
                                        .makeText(
                                            context,
                                            "Podłącz przewodowe słuchawki (jack/USB), aby włączyć tryb DAF.",
                                            Toast.LENGTH_LONG
                                        )
                                        .show()
                                }
                            } else {
                                dafEnabled = false
                            }
                        }
                    )
                }

                Divider()

                // Delay
                Text(
                    text = "Opóźnienie DAF (ms)",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Zakres terapeutyczny zwykle 70–220 ms. Wyższe wartości dają wyraźniejsze \"echo\" własnego głosu.",
                    style = MaterialTheme.typography.bodySmall
                )
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Slider(
                        value = delayMs,
                        onValueChange = { delayMs = it },
                        valueRange = 0f..300f,
                        steps = 300 / 5 - 1,
                        modifier = Modifier.weight(1f),
                        enabled = dafEnabled,
                        colors = SliderDefaults.colors(
                            thumbColor = MaterialTheme.colorScheme.primary,
                            activeTrackColor = MaterialTheme.colorScheme.primary
                        )
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = "${delayMs.roundToInt()} ms",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Divider()

                // Gain
                Text(
                    text = "Głośność / wzmocnienie DAF",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Dopasuj tak, żeby dziecko dobrze słyszało własny głos, ale bez przesterów i dyskomfortu.",
                    style = MaterialTheme.typography.bodySmall
                )
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Slider(
                        value = gain,
                        onValueChange = { gain = it },
                        valueRange = 0.4f..2.0f,
                        steps = 8,
                        modifier = Modifier.weight(1f),
                        colors = SliderDefaults.colors(
                            thumbColor = MaterialTheme.colorScheme.primary,
                            activeTrackColor = MaterialTheme.colorScheme.primary
                        )
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = String.format("%.1f×", gain),
                        style = MaterialTheme.typography.bodySmall
                    )
                }
            }
        }
    }
}

/**
 * Pionowy LED bar – kilka segmentów „świeci” w zależności od level 0..1.
 */
@Composable
private fun MicLevelBar(
    level: Float,
    modifier: Modifier = Modifier
) {
    val norm = level.coerceIn(0f, 1f)
    val segments = 6

    Column(
        modifier = modifier,
        verticalArrangement = Arrangement.spacedBy(2.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        for (i in (segments - 1) downTo 0) {
            val threshold = (i + 1).toFloat() / segments.toFloat()
            val isActive = norm >= threshold

            val color = when {
                !isActive -> MaterialTheme.colorScheme.surface.copy(alpha = 0.4f)
                norm < 0.25f -> MaterialTheme.colorScheme.secondary
                norm < 0.6f -> MaterialTheme.colorScheme.primary
                else -> MaterialTheme.colorScheme.error
            }

            Box(
                modifier = Modifier
                    .width(14.dp)
                    .height(6.dp)
                    .background(
                        color = color,
                        shape = RoundedCornerShape(3.dp)
                    )
            )
        }
    }
}

/**
 * Sprawdzenie, czy są podłączone przewodowe słuchawki (jack / USB).
 */
private fun hasWiredHeadphones(context: Context): Boolean {
    val audioManager = context.getSystemService(Context.AUDIO_SERVICE) as AudioManager

    return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        val outputs = audioManager.getDevices(AudioManager.GET_DEVICES_OUTPUTS)
        outputs.any { dev ->
            dev.type == AudioDeviceInfo.TYPE_WIRED_HEADPHONES ||
                    dev.type == AudioDeviceInfo.TYPE_WIRED_HEADSET
        }
    } else {
        @Suppress("DEPRECATION")
        audioManager.isWiredHeadsetOn
    }
}


@Composable
private fun DafPresetButton(
    label: String,
    selected: Boolean,
    onClick: () -> Unit
) {
    val colors = if (selected) {
        ButtonDefaults.buttonColors(
            containerColor = MaterialTheme.colorScheme.primary,
            contentColor = MaterialTheme.colorScheme.onPrimary
        )
    } else {
        ButtonDefaults.buttonColors()
    }

    Button(
        onClick = onClick,
        modifier = Modifier.weight(1f),
        colors = colors
    ) {
        Text(
            text = label,
            style = MaterialTheme.typography.labelSmall,
            textAlign = TextAlign.Center
        )
    }
}


