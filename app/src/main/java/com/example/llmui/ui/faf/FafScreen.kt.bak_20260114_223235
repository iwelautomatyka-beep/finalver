package com.example.llmui.ui.faf

import android.content.Context
import android.media.AudioDeviceInfo
import android.media.AudioManager
import android.widget.Toast
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Divider
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Slider
import androidx.compose.material3.SliderDefaults
import androidx.compose.material3.Switch
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.example.llmui.audio.OboeDsp
import kotlin.math.abs
import kotlin.math.pow
import kotlin.math.roundToInt

// Presety FAF – różne kombinacje pitch + mix
private enum class FafPreset {
    SOFT, STANDARD, STRONG
}

@Composable
fun FafScreen() {
    val context = LocalContext.current

    var fafEnabled by rememberSaveable { mutableStateOf(false) }
    // zakres +/- 3 półtony
    var pitchSemitones by rememberSaveable { mutableStateOf(0f) }
    var mix by rememberSaveable { mutableStateOf(0.0f) }
    var currentPreset by rememberSaveable { mutableStateOf<FafPreset?>(null) }

    // LED – przybliżona "moc" efektu
    val ledLevel = if (fafEnabled) {
        val pitchPart = (abs(pitchSemitones) / 3f).coerceIn(0f, 1f)
        val mixPart = mix.coerceIn(0f, 1f)
        (0.5f * pitchPart + 0.5f * mixPart).coerceIn(0f, 1f)
    } else {
        0f
    }

    val ledStatusText = when {
        !fafEnabled -> "FAF wyłączony"
        ledLevel < 0.25f -> "Delikatny efekt"
        ledLevel < 0.6f -> "Wyraźny efekt"
        else -> "Mocne przestrojenie"
    }

    // Start / stop silnika
    LaunchedEffect(fafEnabled) {
        try {
            if (fafEnabled) {
                OboeDsp.start()
                // wyłączamy DAF, zostawiamy tylko FAF
                OboeDsp.setFeedbackMode(false)
                OboeDsp.setDelayMs(0)
            } else {
                OboeDsp.setFafMix(0f)
                OboeDsp.setFafPitchRatio(1.0f)
                OboeDsp.stop()
            }
        } catch (_: Throwable) {
        }
    }

    // Aktualizacja parametrów FAF
    LaunchedEffect(fafEnabled, pitchSemitones, mix) {
        if (!fafEnabled) return@LaunchedEffect
        try {
            val ratio = semitonesToRatio(pitchSemitones)
            OboeDsp.setFafPitchRatio(ratio)
            OboeDsp.setFafMix(mix)
        } catch (_: Throwable) {
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .verticalScroll(rememberScrollState())
            .padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        // NAGŁÓWEK + MIC LEVEL – jak w DAF
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surfaceVariant
            )
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(
                    modifier = Modifier.weight(1f, fill = true),
                    verticalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    Text(
                        text = "Tryb FAF – Frequency Altered Feedback",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "Głos dziecka jest lekko przestrojony (wyższy / niższy). " +
                                "Mózg reaguje na taki odsłuch podobnie jak na DAF – " +
                                "może to dodatkowo pomagać w „zawieszaniu\" jąkania.",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Column(
                    modifier = Modifier
                        .padding(start = 12.dp)
                        .width(72.dp),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.Center
                ) {
                    Text(
                        text = "MIC",
                        style = MaterialTheme.typography.labelSmall
                    )
                    Spacer(modifier = Modifier.height(4.dp))
                    MicLevelBar(
                        level = ledLevel,
                        modifier = Modifier
                            .height(52.dp)
                            .width(14.dp)
                    )
                    Spacer(modifier = Modifier.height(4.dp))
                    Text(
                        text = ledStatusText,
                        style = MaterialTheme.typography.labelSmall,
                        textAlign = TextAlign.Center
                    )
                }
            }
        }

        // BLOK FAF – WŁĄCZNIK + PITCH + MIX + PRESETY
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {

                // 1. Główny włącznik FAF z blokadą słuchawek
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Column(
                        modifier = Modifier.weight(1f, fill = true),
                        verticalArrangement = Arrangement.spacedBy(2.dp)
                    ) {
                        Text(
                            text = "FAF – przestrojony odsłuch",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.SemiBold
                        )
                        Text(
                            text = "Działa tylko na słuchawkach przewodowych. " +
                                    "Bez słuchawek nie włączysz trybu (ochrona słuchu).",
                            style = MaterialTheme.typography.bodySmall
                        )
                    }
                    Switch(
                        checked = fafEnabled,
                        onCheckedChange = { checked ->
                            if (checked) {
                                if (!areHeadphonesConnected(context)) {
                                    Toast
                                        .makeText(
                                            context,
                                            "Podłącz słuchawki przewodowe, żeby włączyć FAF.",
                                            Toast.LENGTH_LONG
                                        )
                                        .show()
                                } else {
                                    fafEnabled = true
                                }
                            } else {
                                fafEnabled = false
                                currentPreset = null
                            }
                        }
                    )
                }

                Divider()

                // 2. Pitch (półtony)
                Text(
                    text = "Zmiana wysokości głosu (półtony)",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Zakres około -3 do +3 półtony. " +
                            "Dodatnie wartości = głos wyższy, ujemne = głos niższy.",
                    style = MaterialTheme.typography.bodySmall
                )

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Slider(
                        value = pitchSemitones,
                        onValueChange = {
                            pitchSemitones = it
                            currentPreset = null
                        },
                        valueRange = -3f..3f,
                        steps = 5,
                        modifier = Modifier.weight(1f, fill = true),
                        enabled = fafEnabled,
                        colors = SliderDefaults.colors(
                            thumbColor = MaterialTheme.colorScheme.primary,
                            activeTrackColor = MaterialTheme.colorScheme.primary
                        )
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = " st",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Divider()

                // 3. Miks FAF
                Text(
                    text = "Miks FAF (ile przestrojonego głosu)",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "0% = tylko naturalny głos, 100% = tylko przestrojony. " +
                            "Najczęściej komfortowo jest w okolicach 40–70%.",
                    style = MaterialTheme.typography.bodySmall
                )

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Slider(
                        value = mix,
                        onValueChange = {
                            mix = it
                            currentPreset = null
                        },
                        valueRange = 0f..1f,
                        steps = 9,
                        modifier = Modifier.weight(1f, fill = true),
                        enabled = fafEnabled,
                        colors = SliderDefaults.colors(
                            thumbColor = MaterialTheme.colorScheme.primary,
                            activeTrackColor = MaterialTheme.colorScheme.primary
                        )
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = "%",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Divider()

                // 4. Presety FAF – styl jak w DAF
                Text(
                    text = "Presety FAF",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Gotowe kombinacje przestrojenia i miksu. " +
                            "Działają tylko gdy FAF jest włączony.",
                    style = MaterialTheme.typography.bodySmall
                )

                FafPresetButton(
                    label = "Łagodny (+1 st, ok. 40%)",
                    description = "Delikatnie wyższy głos, miękki efekt.",
                    selected = currentPreset == FafPreset.SOFT,
                    enabled = fafEnabled,
                    onClick = {
                        if (!fafEnabled) {
                            Toast.makeText(
                                context,
                                "Najpierw włącz FAF przełącznikiem powyżej.",
                                Toast.LENGTH_SHORT
                            ).show()
                        } else {
                            pitchSemitones = 1f
                            mix = 0.4f
                            currentPreset = FafPreset.SOFT
                        }
                    }
                )

                FafPresetButton(
                    label = "Standard (+2 st, ok. 60%)",
                    description = "Wyraźny efekt, codzienne ćwiczenia.",
                    selected = currentPreset == FafPreset.STANDARD,
                    enabled = fafEnabled,
                    onClick = {
                        if (!fafEnabled) {
                            Toast.makeText(
                                context,
                                "Najpierw włącz FAF przełącznikiem powyżej.",
                                Toast.LENGTH_SHORT
                            ).show()
                        } else {
                            pitchSemitones = 2f
                            mix = 0.6f
                            currentPreset = FafPreset.STANDARD
                        }
                    }
                )

                FafPresetButton(
                    label = "Mocny (+3 st, ok. 75%)",
                    description = "Najsilniejsze przestrojenie, krótkie sesje.",
                    selected = currentPreset == FafPreset.STRONG,
                    enabled = fafEnabled,
                    onClick = {
                        if (!fafEnabled) {
                            Toast.makeText(
                                context,
                                "Najpierw włącz FAF przełącznikiem powyżej.",
                                Toast.LENGTH_SHORT
                            ).show()
                        } else {
                            pitchSemitones = 3f
                            mix = 0.75f
                            currentPreset = FafPreset.STRONG
                        }
                    }
                )
            }
        }

        // Tipy
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surfaceVariant
            )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = "Jak używać FAF?",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "• Zacznij od presetów: Standard lub Łagodny.\n" +
                            "• FAF traktuj jako dodatek do DAF – nie musi być włączony cały czas.\n" +
                            "• Jeśli dziecko źle znosi przestrojony głos – zmniejsz miks albo wyłącz FAF.",
                    style = MaterialTheme.typography.bodySmall
                )
            }
        }
    }
}

/**
 * Sprawdza, czy są podłączone przewodowe słuchawki / headset.
 */
private fun areHeadphonesConnected(context: Context): Boolean {
    val audioManager = context.getSystemService(Context.AUDIO_SERVICE) as? AudioManager ?: return false
    val devices = audioManager.getDevices(AudioManager.GET_DEVICES_OUTPUTS)
    return devices.any { info ->
        info.type == AudioDeviceInfo.TYPE_WIRED_HEADSET ||
                info.type == AudioDeviceInfo.TYPE_WIRED_HEADPHONES
    }
}

/**
 * Prosty pionowy LED bar – jak w zakładce DAF.
 */
@Composable
private fun MicLevelBar(
    level: Float,
    modifier: Modifier = Modifier
) {
    val norm = level.coerceIn(0f, 1f)
    val segments = 6

    Column(
        modifier = modifier,
        verticalArrangement = Arrangement.spacedBy(2.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        for (i in (segments - 1) downTo 0) {
            val threshold = (i + 1).toFloat() / segments.toFloat()
            val isActive = norm >= threshold

            val color = when {
                !isActive -> MaterialTheme.colorScheme.surface.copy(alpha = 0.4f)
                norm < 0.25f -> MaterialTheme.colorScheme.secondary
                norm < 0.6f -> MaterialTheme.colorScheme.primary
                else -> MaterialTheme.colorScheme.error
            }

            Box(
                modifier = Modifier
                    .width(14.dp)
                    .height(6.dp)
                    .background(
                        color = color,
                        shape = RoundedCornerShape(3.dp)
                    )
            )
        }
    }
}

/**
 * Jeden przycisk presetu FAF – wygląd jak w DAF.
 */
@Composable
private fun FafPresetButton(
    label: String,
    description: String,
    selected: Boolean,
    enabled: Boolean,
    onClick: () -> Unit
) {
    Button(
        onClick = onClick,
        enabled = enabled,
        modifier = Modifier.fillMaxWidth(),
        colors = if (selected) {
            ButtonDefaults.buttonColors()
        } else {
            ButtonDefaults.buttonColors(
                containerColor = MaterialTheme.colorScheme.surfaceVariant,
                contentColor = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    ) {
        Column(
            verticalArrangement = Arrangement.spacedBy(2.dp),
            modifier = Modifier.fillMaxWidth()
        ) {
            Text(
                text = if (selected) "  ✓" else label,
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = if (selected) FontWeight.SemiBold else FontWeight.Normal
            )
            Text(
                text = description,
                style = MaterialTheme.typography.bodySmall
            )
        }
    }
}

/**
 * Konwersja półtonów na współczynnik pitch (ratio).
 */
private fun semitonesToRatio(semitones: Float): Float {
    return 2.0f.pow(semitones / 12f)
}
