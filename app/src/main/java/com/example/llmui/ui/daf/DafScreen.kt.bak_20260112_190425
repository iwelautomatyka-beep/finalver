package com.example.llmui.ui.daf

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Divider
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Slider
import androidx.compose.material3.SliderDefaults
import androidx.compose.material3.Switch
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.example.llmui.audio.OboeDsp
import kotlin.math.roundToInt

// Proste profile „brzmienia” DAF – działają tylko przez korektę gainu
private enum class DafProfile {
    NEUTRAL,
    SOFT,
    BRIGHT
}

@Composable
fun DafScreen() {
    var delayMs by rememberSaveable { mutableStateOf(120f) }      // slider DAF
    var gain by rememberSaveable { mutableStateOf(1.1f) }         // 0.4–2.0
    var feedbackEnabled by rememberSaveable { mutableStateOf(true) }

    // Test-tone zostaje w silniku, ale jest zawsze wyłączony (brak UI)
    var testToneEnabled by rememberSaveable { mutableStateOf(false) }

    // „Mute DAF” – wyłącza efekt (delay=0 / feedback off), ale nie rusza slidera
    var muteEnabled by rememberSaveable { mutableStateOf(false) }
    var lastDelayBeforeMute by rememberSaveable { mutableStateOf(120f) }

    // Nowe: profil brzmienia
    var profileIndex by rememberSaveable { mutableStateOf(DafProfile.NEUTRAL.ordinal) }
    val profile = DafProfile.values()[profileIndex.coerceIn(0, DafProfile.values().size - 1)]

    // Gain używany do LED i do silnika (po lekkiej korekcie w zależności od profilu)
    val effectiveGainForUi = when (profile) {
        DafProfile.NEUTRAL -> gain
        DafProfile.SOFT -> (gain * 0.85f).coerceIn(0.4f, 2.0f)
        DafProfile.BRIGHT -> (gain * 1.15f).coerceIn(0.4f, 2.0f)
    }

    // LED bar – oparty o effectiveGain + stan DAF
    val ledLevel =
        if (feedbackEnabled && !muteEnabled) (effectiveGainForUi / 2f).coerceIn(0f, 1f)
        else 0f

    val ledStatusText = when {
        !feedbackEnabled && !testToneEnabled -> "DAF wyłączony"
        muteEnabled -> "Mute – bez opóźnienia"
        ledLevel < 0.25f -> "Delikatny odsłuch"
        ledLevel < 0.6f -> "Komfortowy poziom"
        else -> "Uwaga: może być głośno"
    }

    // Sterowanie natywnym silnikiem DAF – start/stop
    LaunchedEffect(feedbackEnabled, testToneEnabled) {
        try {
            if (feedbackEnabled || testToneEnabled) {
                OboeDsp.start()
            } else {
                OboeDsp.stop()
            }
        } catch (_: Throwable) {
            // bez crashy
        }
    }

    // Parametry DAF w silniku (delay, gain, feedback)
    LaunchedEffect(
        delayMs,
        gain,
        feedbackEnabled,
        testToneEnabled,
        muteEnabled,
        profileIndex
    ) {
        val realDelay = if (muteEnabled) 0 else delayMs.roundToInt()
        val engineGain = when (profile) {
            DafProfile.NEUTRAL -> gain
            DafProfile.SOFT -> (gain * 0.85f).coerceIn(0.4f, 2.0f)
            DafProfile.BRIGHT -> (gain * 1.15f).coerceIn(0.4f, 2.0f)
        }

        try {
            OboeDsp.setDelayMs(realDelay)
            OboeDsp.setGain(engineGain)
            OboeDsp.setFeedbackMode(feedbackEnabled && !muteEnabled)
            OboeDsp.setTestToneEnabled(testToneEnabled)
        } catch (_: Throwable) {
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        // GÓRNY NAGŁÓWEK + LED BAR PO PRAWEJ
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surfaceVariant
            )
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(
                    modifier = Modifier.weight(1f),
                    verticalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    Text(
                        text = "Tryb DAF – Delayed Auditory Feedback",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "Ustaw opóźnienie i głośność, mów do mikrofonu w słuchawkach przewodowych. Ćwiczenia i wyniki znajdziesz w osobnych zakładkach.",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Column(
                    modifier = Modifier
                        .padding(start = 12.dp)
                        .width(72.dp),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.Center
                ) {
                    Text(
                        text = "MIC",
                        style = MaterialTheme.typography.labelSmall
                    )
                    Spacer(modifier = Modifier.height(4.dp))
                    MicLevelBar(
                        level = ledLevel,
                        modifier = Modifier
                            .height(52.dp)
                            .width(14.dp)
                    )
                    Spacer(modifier = Modifier.height(4.dp))
                    Text(
                        text = ledStatusText,
                        style = MaterialTheme.typography.labelSmall,
                        textAlign = TextAlign.Center
                    )
                }
            }
        }

        // BLOK KONTROLEK DAF
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                // Delay
                Text(
                    text = "Opóźnienie DAF (ms)",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Typowy zakres terapeutyczny: 70–200 ms. Wyższe wartości dają wyraźniejsze \"odbicie\" głosu.",
                    style = MaterialTheme.typography.bodySmall
                )
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Slider(
                        value = delayMs,
                        onValueChange = {
                            delayMs = it
                            if (!muteEnabled && it > 0f) {
                                lastDelayBeforeMute = it
                            }
                        },
                        valueRange = 0f..300f,
                        steps = 300 / 5 - 1,
                        modifier = Modifier.weight(1f),
                        enabled = !muteEnabled
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = "${delayMs.roundToInt()} ms",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Divider()

                // Gain
                Text(
                    text = "Głośność / wzmocnienie DAF",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Dopasuj tak, żeby dziecko dobrze słyszało własny głos, ale bez przesterów i dyskomfortu.",
                    style = MaterialTheme.typography.bodySmall
                )
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Slider(
                        value = gain,
                        onValueChange = { gain = it },
                        valueRange = 0.4f..2.0f,
                        steps = 8,
                        modifier = Modifier.weight(1f),
                        colors = SliderDefaults.colors(
                            thumbColor = MaterialTheme.colorScheme.primary,
                            activeTrackColor = MaterialTheme.colorScheme.primary
                        )
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = String.format("%.1f×", gain),
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Divider()

                // NOWE: profil brzmienia
                Text(
                    text = "Profil brzmienia DAF",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Neutralny – jak do tej pory. „Miękki” delikatnie łagodzi efekt, „Wyraźny” lekko go wzmacnia.",
                    style = MaterialTheme.typography.bodySmall
                )

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    DafProfile.values().forEach { p ->
                        val selected = profile == p
                        val label = when (p) {
                            DafProfile.NEUTRAL -> "Neutralny"
                            DafProfile.SOFT -> "Miękki"
                            DafProfile.BRIGHT -> "Wyraźny"
                        }
                        val bg = if (selected) {
                            MaterialTheme.colorScheme.primary
                        } else {
                            MaterialTheme.colorScheme.surfaceVariant
                        }
                        val fg = if (selected) {
                            MaterialTheme.colorScheme.onPrimary
                        } else {
                            MaterialTheme.colorScheme.onSurfaceVariant
                        }

                        Box(
                            modifier = Modifier
                                .weight(1f)
                                .height(32.dp)
                                .clip(RoundedCornerShape(16.dp))
                                .background(bg)
                                .clickable { profileIndex = p.ordinal }
                                .padding(horizontal = 4.dp),
                            contentAlignment = Alignment.Center
                        ) {
                            Text(
                                text = label,
                                style = MaterialTheme.typography.labelMedium,
                                color = fg,
                                textAlign = TextAlign.Center
                            )
                        }
                    }
                }

                Divider()

                // Feedback ON/OFF
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Column(
                        modifier = Modifier.weight(1f),
                        verticalArrangement = Arrangement.spacedBy(2.dp)
                    ) {
                        Text(
                            text = "Feedback (odsłuch własnego głosu)",
                            style = MaterialTheme.typography.titleSmall
                        )
                        Text(
                            text = "Po włączeniu słyszysz własny głos z opóźnieniem. Używaj tylko na słuchawkach przewodowych.",
                            style = MaterialTheme.typography.bodySmall
                        )
                    }
                    Switch(
                        checked = feedbackEnabled,
                        onCheckedChange = { feedbackEnabled = it }
                    )
                }

                // MUTE – przełącznik jak feedback
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Column(
                        modifier = Modifier.weight(1f),
                        verticalArrangement = Arrangement.spacedBy(2.dp)
                    ) {
                        Text(
                            text = "Mute DAF (bez opóźnienia)",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.SemiBold
                        )
                        Text(
                            text = "Wyłącza efekt DAF (opóźnienie=0), tak aby terapeuta mógł swobodnie mówić do dziecka bez echa.",
                            style = MaterialTheme.typography.bodySmall
                        )
                    }
                    Switch(
                        checked = muteEnabled,
                        onCheckedChange = { isOn ->
                            if (isOn) {
                                if (delayMs > 0f) {
                                    lastDelayBeforeMute = delayMs
                                }
                                muteEnabled = true
                            } else {
                                muteEnabled = false
                                if (lastDelayBeforeMute <= 0f) {
                                    lastDelayBeforeMute = 120f
                                }
                                delayMs = lastDelayBeforeMute
                            }
                        }
                    )
                }
            }
        }

        // Proste „Ćwiczenia DAF” – skrót
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surfaceVariant
            )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = "Ćwiczenia DAF (skrót)",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "• Czytanie sylab / rymów 🗣️ – wolne tempo, krótkie rzędy \"pa-ta-ka\", „ma-na-la\".\n" +
                            "• Krótkie zdania z pauzami ⏱️ – np. opis dnia w tempie „slow motion”.\n" +
                            "• Dialogi w rolach 🎭 – sklep, lekarz, plac zabaw – przygotowanie do realnych sytuacji.",
                    style = MaterialTheme.typography.bodySmall
                )
                Text(
                    text = "Pełne scenariusze z gotowymi tekstami i tipami znajdziesz w zakładce Ćwiczenia.",
                    style = MaterialTheme.typography.bodySmall,
                    textAlign = TextAlign.Start
                )
            }
        }
    }
}

/**
 * Pionowy LED bar – kilka segmentów „świeci” w zależności od level 0..1.
 */
@Composable
private fun MicLevelBar(
    level: Float,
    modifier: Modifier = Modifier
) {
    val norm = level.coerceIn(0f, 1f)
    val segments = 6

    Column(
        modifier = modifier,
        verticalArrangement = Arrangement.spacedBy(2.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        for (i in (segments - 1) downTo 0) {
            val threshold = (i + 1).toFloat() / segments.toFloat()
            val isActive = norm >= threshold

            val color = when {
                !isActive -> MaterialTheme.colorScheme.surface.copy(alpha = 0.4f)
                norm < 0.25f -> MaterialTheme.colorScheme.secondary
                norm < 0.6f -> MaterialTheme.colorScheme.primary
                else -> MaterialTheme.colorScheme.error
            }

            Box(
                modifier = Modifier
                    .width(14.dp)
                    .height(6.dp)
                    .background(
                        color = color,
                        shape = RoundedCornerShape(3.dp)
                    )
            )
        }
    }
}
