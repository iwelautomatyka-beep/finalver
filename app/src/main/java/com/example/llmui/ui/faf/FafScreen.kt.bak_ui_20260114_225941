package com.example.llmui.ui.faf

import android.content.Context
import android.media.AudioDeviceInfo
import android.media.AudioManager
import android.widget.Toast
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Divider
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Slider
import androidx.compose.material3.SliderDefaults
import androidx.compose.material3.Switch
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.example.llmui.audio.OboeDsp
import kotlin.math.pow
import kotlin.math.roundToInt

private enum class FafPreset {
    SOFT, STANDARD, STRONG
}

@Composable
fun FafScreen() {
    val context = LocalContext.current

    var fafEnabled by rememberSaveable { mutableStateOf(false) }
    var pitchSemitones by rememberSaveable { mutableStateOf(2f) } // domyślnie lekko wyżej
    var mix by rememberSaveable { mutableStateOf(0.7f) }          // domyślnie mocny FAF
    var currentPreset by rememberSaveable { mutableStateOf<FafPreset?>(FafPreset.STANDARD) }

    Scaffold { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(innerPadding)
                .padding(16.dp)
                .verticalScroll(rememberScrollState()),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // NAGŁÓWEK
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.surfaceVariant
                )
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(12.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Text(
                        text = "Tryb FAF – Frequency Altered Feedback",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "FAF lekko podnosi lub obniża wysokość głosu. " +
                                "Mózg „gubi się” w odsłuchu, co może dodatkowo pomagać w płynności mówienia.",
                        style = MaterialTheme.typography.bodySmall
                    )
                }
            }

            // GŁÓWNY BLOK STEROWANIA
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.surface
                )
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(12.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    // 1. Włącznik FAF z blokadą słuchawek
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Column(
                            modifier = Modifier.weight(1f, fill = true),
                            verticalArrangement = Arrangement.spacedBy(4.dp)
                        ) {
                            Text(
                                text = "FAF – zmiana wysokości głosu",
                                style = MaterialTheme.typography.titleSmall,
                                fontWeight = FontWeight.SemiBold
                            )
                            Text(
                                text = "Działa najlepiej razem z DAF. Wymaga słuchawek przewodowych – " +
                                        "bez nich efekt jest wyłączony.",
                                style = MaterialTheme.typography.bodySmall
                            )
                        }
                        Switch(
                            checked = fafEnabled,
                            onCheckedChange = { checked ->
                                if (checked) {
                                    if (!areHeadphonesConnected(context)) {
                                        Toast.makeText(
                                            context,
                                            "Podłącz słuchawki przewodowe, żeby włączyć FAF.",
                                            Toast.LENGTH_LONG
                                        ).show()
                                    } else {
                                        fafEnabled = true
                                    }
                                } else {
                                    fafEnabled = false
                                    currentPreset = null
                                }
                            }
                        )
                    }

                    Divider()

                    // 2. Suwak wysokości
                    Text(
                        text = "Zmiana wysokości głosu (półtony)",
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "Zakres od -4 do +4 półtonów. W praktyce zwykle wystarcza +2 lub +3.",
                        style = MaterialTheme.typography.bodySmall
                    )
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Slider(
                            value = pitchSemitones,
                            onValueChange = {
                                pitchSemitones = it
                                currentPreset = null
                            },
                            valueRange = -4f..4f,
                            steps = 7,
                            enabled = fafEnabled,
                            modifier = Modifier.weight(1f, fill = true),
                            colors = SliderDefaults.colors(
                                thumbColor = MaterialTheme.colorScheme.primary,
                                activeTrackColor = MaterialTheme.colorScheme.primary
                            )
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                        Text(
                            text = "${pitchSemitones.roundToInt()} st",
                            style = MaterialTheme.typography.bodySmall
                        )
                    }

                    Divider()

                    // 3. Suwak miksu
                    Text(
                        text = "Miks FAF (ile zmienionego głosu)",
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "0% = normalny głos, 100% = tylko FAF. Zwykle 50–80% jest najbardziej komfortowe.",
                        style = MaterialTheme.typography.bodySmall
                    )
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Slider(
                            value = mix,
                            onValueChange = {
                                mix = it
                                currentPreset = null
                            },
                            valueRange = 0f..1f,
                            steps = 9,
                            enabled = fafEnabled,
                            modifier = Modifier.weight(1f, fill = true),
                            colors = SliderDefaults.colors(
                                thumbColor = MaterialTheme.colorScheme.primary,
                                activeTrackColor = MaterialTheme.colorScheme.primary
                            )
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                        Text(
                            text = "${(mix * 100).roundToInt()}%",
                            style = MaterialTheme.typography.bodySmall
                        )
                    }

                    Divider()

                    // 4. Presety FAF
                    Text(
                        text = "Presety FAF",
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "Gotowe kombinacje wysokości i miksu. Działają tylko gdy FAF jest włączony.",
                        style = MaterialTheme.typography.bodySmall
                    )

                    FafPresetButton(
                        label = "Łagodny",
                        description = "+1 półton, ok. 40% miksu",
                        selected = currentPreset == FafPreset.SOFT,
                        enabled = fafEnabled
                    ) {
                        pitchSemitones = 1f
                        mix = 0.4f
                        currentPreset = FafPreset.SOFT
                    }

                    FafPresetButton(
                        label = "Standard",
                        description = "+2 półtony, ok. 70% miksu",
                        selected = currentPreset == FafPreset.STANDARD,
                        enabled = fafEnabled
                    ) {
                        pitchSemitones = 2f
                        mix = 0.7f
                        currentPreset = FafPreset.STANDARD
                    }

                    FafPresetButton(
                        label = "Mocny",
                        description = "+3 półtony, ok. 90% miksu",
                        selected = currentPreset == FafPreset.STRONG,
                        enabled = fafEnabled
                    ) {
                        pitchSemitones = 3f
                        mix = 0.9f
                        currentPreset = FafPreset.STRONG
                    }
                }
            }

            // TIPY
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.surfaceVariant
                )
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(12.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Text(
                        text = "Jak używać FAF?",
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "• Najpierw ustaw komfortowy DAF w osobnej zakładce.\n" +
                                "• Potem włącz FAF i wybierz preset Standard.\n" +
                                "• Jeśli efekt jest zbyt męczący – zmniejsz miks albo wybierz Łagodny.",
                        style = MaterialTheme.typography.bodySmall
                    )
                }
            }
        }
    }

    // LOGIKA AUDIO – jedna LaunchedEffect na końcu
    LaunchedEffect(fafEnabled, pitchSemitones, mix) {
        try {
            if (!fafEnabled) {
                // wyłączamy tylko tor FAF – DAF zostaje jak był
                OboeDsp.setFafMix(0f)
            } else {
                if (!areHeadphonesConnected(context)) {
                    OboeDsp.setFafMix(0f)
                    return@LaunchedEffect
                }
                if (!OboeDsp.start()) {
                    return@LaunchedEffect
                }
                applyFafToEngine(pitchSemitones, mix)
            }
        } catch (_: Throwable) {
        }
    }
}

private fun applyFafToEngine(pitchSemitones: Float, mix: Float) {
    val ratio = pitchRatioFromSemitones(pitchSemitones)
    OboeDsp.setFafPitchRatio(ratio)
    OboeDsp.setFafMix(mix)
}

private fun pitchRatioFromSemitones(semitones: Float): Float {
    val ratio = 2.0.pow(semitones.toDouble() / 12.0).toFloat()
    return ratio
}

/**
 * Kopia helpera z DafScreen – sprawdzamy przewodowe słuchawki.
 */
private fun areHeadphonesConnected(context: Context): Boolean {
    val audioManager = context.getSystemService(Context.AUDIO_SERVICE) as? AudioManager ?: return false
    val devices = audioManager.getDevices(AudioManager.GET_DEVICES_OUTPUTS)
    return devices.any { info ->
        info.type == AudioDeviceInfo.TYPE_WIRED_HEADSET ||
                info.type == AudioDeviceInfo.TYPE_WIRED_HEADPHONES
    }
}

@Composable
private fun FafPresetButton(
    label: String,
    description: String,
    selected: Boolean,
    enabled: Boolean,
    onClick: () -> Unit
) {
    Button(
        onClick = onClick,
        enabled = enabled,
        modifier = Modifier.fillMaxWidth(),
    ) {
        Column(
            verticalArrangement = Arrangement.spacedBy(2.dp),
            modifier = Modifier.fillMaxWidth()
        ) {
            Text(
                text = if (selected) "$label  (aktywne)" else label,
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = if (selected) FontWeight.SemiBold else FontWeight.Normal,
                textAlign = TextAlign.Start
            )
            Text(
                text = description,
                style = MaterialTheme.typography.bodySmall
            )
        }
    }
}
