package com.example.llmui.ui.faf

import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Slider
import androidx.compose.material3.SliderDefaults
import androidx.compose.material3.Switch
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.example.llmui.audio.OboeDsp
import kotlin.math.roundToInt

private enum class FafPreset {
    SOFT, STANDARD, STRONG
}

/**
 * FAF – Frequency Altered Feedback (wersja oparta o istniejący silnik DAF).
 *
 * Technicznie korzystamy z tego samego łańcucha audio co DAF, ale z innymi
 * ustawieniami miksu / opóźnienia / głośności. Dzięki temu użytkownik dostaje
 * osobną zakładkę „FAF” z prostymi presetami.
 */
@Composable
fun FafScreen() {
    var fafEnabled by rememberSaveable { mutableStateOf(false) }
    var preset by rememberSaveable { mutableStateOf(FafPreset.STANDARD) }
    var intensity by rememberSaveable { mutableStateOf(0.6f) } // 0..1

    // Start/stop silnika
    LaunchedEffect(fafEnabled) {
        try {
            if (fafEnabled) {
                OboeDsp.start()
            } else {
                // przy wyłączeniu FAF czyścimy efekt
                OboeDsp.setFeedbackMode(false)
                OboeDsp.setDelayMs(0)
            }
        } catch (_: Throwable) {
        }
    }

    // Aktualizacja presetu przy zmianie
    LaunchedEffect(fafEnabled, preset, intensity) {
        if (!fafEnabled) return@LaunchedEffect
        applyFafPreset(preset = preset, intensity = intensity)
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
            .verticalScroll(rememberScrollState()),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {

        // Główny opis + włącznik
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surfaceVariant
            )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = "Tryb FAF – Frequency Altered Feedback",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "FAF to odmiana odsłuchu, w której brzmienie własnego głosu jest modyfikowane. " +
                            "W tej wersji korzystamy z tego samego toru audio, co w DAF, ale z innymi ustawieniami.",
                    style = MaterialTheme.typography.bodySmall
                )

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Column(
                        modifier = Modifier.weight(1f),
                        verticalArrangement = Arrangement.spacedBy(2.dp)
                    ) {
                        Text(
                            text = if (fafEnabled) "FAF jest włączony" else "FAF jest wyłączony",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Medium
                        )
                        Text(
                            text = "Używaj tylko na słuchawkach przewodowych. Głośność i opóźnienie dopasujesz poniżej.",
                            style = MaterialTheme.typography.bodySmall
                        )
                    }
                    Switch(
                        checked = fafEnabled,
                        onCheckedChange = { fafEnabled = it }
                    )
                }
            }
        }

        // Presety FAF
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                Text(
                    text = "Charakter brzmienia FAF",
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.SemiBold
                )
                Text(
                    text = "Wybierz jeden z gotowych profili. Możesz je dodatkowo dopasować suwakiem intensywności.",
                    style = MaterialTheme.typography.bodySmall
                )

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    FafPresetButton(
                        label = "Łagodny",
                        selected = preset == FafPreset.SOFT,
                        onClick = { preset = FafPreset.SOFT },
                        modifier = Modifier.weight(1f)
                    )
                    FafPresetButton(
                        label = "Standard",
                        selected = preset == FafPreset.STANDARD,
                        onClick = { preset = FafPreset.STANDARD },
                        modifier = Modifier.weight(1f)
                    )
                    FafPresetButton(
                        label = "Mocny",
                        selected = preset == FafPreset.STRONG,
                        onClick = { preset = FafPreset.STRONG },
                        modifier = Modifier.weight(1f)
                    )
                }

                Spacer(modifier = Modifier.height(8.dp))

                Text(
                    text = "Intensywność efektu",
                    style = MaterialTheme.typography.bodyMedium,
                    fontWeight = FontWeight.Medium
                )
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Slider(
                        value = intensity,
                        onValueChange = { intensity = it },
                        valueRange = 0.2f..1.0f,
                        steps = 4,
                        modifier = Modifier.weight(1f),
                        colors = SliderDefaults.colors(
                            thumbColor = MaterialTheme.colorScheme.primary,
                            activeTrackColor = MaterialTheme.colorScheme.primary
                        )
                    )
                    Text(
                        text = "${(intensity * 100).roundToInt()}%",
                        style = MaterialTheme.typography.bodySmall
                    )
                }

                Text(
                    text = "Tip: przy pierwszych próbach zacznij od „Łagodny” + ok. 50–70% intensywności. " +
                            "Jeśli dziecko dobrze toleruje efekt, możesz krótkimi blokami testować mocniejsze ustawienia.",
                    style = MaterialTheme.typography.bodySmall,
                    textAlign = TextAlign.Start
                )
            }
        }
    }
}

@Composable
private fun FafPresetButton(
    label: String,
    selected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val colors = if (selected) {
        ButtonDefaults.buttonColors(
            containerColor = MaterialTheme.colorScheme.primary,
            contentColor = MaterialTheme.colorScheme.onPrimary
        )
    } else {
        ButtonDefaults.buttonColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant,
            contentColor = MaterialTheme.colorScheme.onSurface
        )
    }

    Button(
        onClick = onClick,
        modifier = modifier.height(40.dp),
        colors = colors
    ) {
        Text(
            text = label,
            style = MaterialTheme.typography.labelLarge
        )
    }
}

private fun applyFafPreset(
    preset: FafPreset,
    intensity: Float
) {
    // Bazowe parametry dla poszczególnych presetów
    val baseDelayMs: Int
    val baseGain: Float

    when (preset) {
        FafPreset.SOFT -> {
            baseDelayMs = 60  // delikatne przesunięcie czasowe
            baseGain = 0.9f
        }
        FafPreset.STANDARD -> {
            baseDelayMs = 80
            baseGain = 1.1f
        }
        FafPreset.STRONG -> {
            baseDelayMs = 110
            baseGain = 1.3f
        }
    }

    // Intensywność 0.2–1.0 skaluje parametry
    val factor = intensity.coerceIn(0.2f, 1.0f)
    val delayMs = (baseDelayMs * factor).roundToInt().coerceIn(40, 200)
    val gain = (baseGain * (0.7f + 0.6f * factor)).coerceIn(0.6f, 1.6f)

    try {
        OboeDsp.setDelayMs(delayMs)
        OboeDsp.setGain(gain)
        OboeDsp.setFeedbackMode(true)
    } catch (_: Throwable) {
    }
}
